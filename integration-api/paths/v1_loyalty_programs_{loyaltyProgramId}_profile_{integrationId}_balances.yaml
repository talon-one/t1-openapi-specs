get:
  operationId: getLoyaltyBalances
  summary: Get customer's loyalty balances
  description: >
    Retrieve loyalty ledger balances for the given Integration ID in the
    specified loyalty program.

    You can filter balances by date and subledger ID, and include tier-related
    information in the response.


    **Note**: If no filtering options are applied, you retrieve all loyalty
    balances on the current date for the given integration ID.


    Loyalty balances are calculated when Talon.One receives your request using
    the points stored in our database, so retrieving a large number of balances
    at once can impact performance.


    For more information, see:

    - [Managing card-based loyalty program
    data](https://docs.talon.one/docs/product/loyalty-programs/card-based/managing-loyalty-cards)

    - [Managing profile-based loyalty program
    data](https://docs.talon.one/docs/product/loyalty-programs/profile-based/managing-pb-lp-data)
  security:
    - api_key_v1: []
  tags:
    - Loyalty
  parameters:
    - name: loyaltyProgramId
      in: path
      required: true
      description: >
        Identifier of the profile-based loyalty program. You can get the ID with

        the [List loyalty
        programs](https://docs.talon.one/management-api#tag/Loyalty/operation/getLoyaltyPrograms)
        endpoint.
      example: 33
      schema:
        type: integer
    - in: path
      required: true
      name: integrationId
      description: >
        The integration identifier for this customer profile. Must be:

        - Unique within the deployment.

        - Stable for the customer. Do not use an ID that the customer can update
        themselves. For example, you can use a database ID.


        Once set, you cannot update this identifier.
      example: customer1
      schema:
        type: string
    - name: endDate
      in: query
      required: false
      description: >
        Used to return expired, active, and pending loyalty balances before this
        timestamp. You can enter any past, present, or future timestamp value.


        **Note:**


        - It must be an RFC3339 timestamp string.

        - You can include a time component in your string, for example,
        `T23:59:59` to specify the end of the day. The time zone setting
        considered is `UTC`. If you do not include a time component, a default
        time value of `T00:00:00` (midnight) in `UTC` is considered.
      example: '2024-05-29T15:04:05+07:00'
      schema:
        type: string
        format: date-time
    - name: subledgerId
      in: query
      required: false
      description: The ID of the subledger by which we filter the data.
      example: subledger1
      schema:
        type: string
    - name: includeTiers
      in: query
      required: false
      description: >
        Indicates whether tier information is included in the response.


        When set to `true`, the response includes information about the current
        tier and the number of points required to move to next tier.
      example: false
      schema:
        type: boolean
        default: false
    - name: includeProjectedTier
      in: query
      required: false
      description: >
        Indicates whether the customer's projected tier information is included
        in the response.


        When set to `true`, the response includes information about the
        customer's active points and the name of the projected tier.


        **Note** We recommend filtering by `subledgerId` for better performance.
      example: false
      schema:
        type: boolean
        default: false
  responses:
    '200':
      description: OK
      content:
        application/json:
          schema:
            type: object
            description: List of loyalty balances for a ledger and its subledgers.
            properties:
              balance:
                title: Loyalty points balance of a ledger
                allOf:
                  - type: object
                    description: Point balance of a ledger in the Loyalty Program.
                    properties:
                      activePoints:
                        type: number
                        title: Current Balance
                        description: >-
                          Total amount of points awarded to this customer and
                          available to spend.
                        example: 286
                      pendingPoints:
                        type: number
                        title: Total pending points
                        description: >-
                          Total amount of points awarded to this customer but
                          not available until their start date.
                        example: 50
                      spentPoints:
                        type: number
                        title: Total spent points
                        description: Total amount of points already spent by this customer.
                        example: 150
                      expiredPoints:
                        type: number
                        title: Total expired points
                        description: >-
                          Total amount of points awarded but never redeemed.
                          They cannot be used anymore.
                        example: 286
                      negativePoints:
                        type: number
                        title: Current negative balance
                        description: >-
                          Total amount of negative points. This implies that
                          `activePoints` is `0`.
                        example: 286
                  - type: object
                    properties:
                      currentTier:
                        description: Customer's current tier.
                        example: bronze
                        type: object
                        required:
                          - id
                          - name
                        properties:
                          id:
                            type: integer
                            description: The internal ID of the tier.
                            example: 11
                          name:
                            type: string
                            description: The name of the tier.
                            example: bronze
                          startDate:
                            type: string
                            format: date-time
                            description: >-
                              Date and time when the customer moved to this
                              tier. This value uses the loyalty program's time
                              zone setting.
                            example: 2021-05-03T12:32:00Z07:00
                          expiryDate:
                            type: string
                            format: date-time
                            description: >-
                              Date when tier level expires in the RFC3339 format
                              (in the Loyalty Program's timezone).
                            example: 2022-08-02T15:04:05Z07:00
                          downgradePolicy:
                            type: string
                            enum:
                              - one_down
                              - balance_based
                            description: >
                              The policy that defines how customer tiers are
                              downgraded in the loyalty program after tier
                              reevaluation.
                               - `one_down`: If the customer doesn't have enough points to stay in the current tier, they are downgraded by one tier.
                               - `balance_based`: The customer's tier is reevaluated based on the amount of active points they have at the moment.
                      projectedTier:
                        type: object
                        required:
                          - projectedActivePoints
                        properties:
                          projectedActivePoints:
                            type: number
                            description: >-
                              The active points of the customer when their
                              current tier expires.
                            example: 198
                          stayInTierPoints:
                            type: number
                            description: >
                              The number of points the customer needs to stay in
                              the current tier.


                              **Note**: This is included in the response when
                              the customer is projected to be downgraded.
                            example: 2
                          projectedTierName:
                            type: string
                            description: >-
                              The name of the tier the user will enter once
                              their current tier expires.
                            example: Tier 1
                      pointsToNextTier:
                        type: number
                        description: The number of points required to move up a tier.
                        example: 20
                      nextTierName:
                        type: string
                        description: The name of the tier consecutive to the current tier.
                        example: silver
              subledgerBalances:
                type: object
                description: Map of the loyalty balances of the subledgers of a ledger.
                additionalProperties:
                  allOf:
                    - type: object
                      description: Point balance of a ledger in the Loyalty Program.
                      properties:
                        activePoints:
                          type: number
                          title: Current Balance
                          description: >-
                            Total amount of points awarded to this customer and
                            available to spend.
                          example: 286
                        pendingPoints:
                          type: number
                          title: Total pending points
                          description: >-
                            Total amount of points awarded to this customer but
                            not available until their start date.
                          example: 50
                        spentPoints:
                          type: number
                          title: Total spent points
                          description: >-
                            Total amount of points already spent by this
                            customer.
                          example: 150
                        expiredPoints:
                          type: number
                          title: Total expired points
                          description: >-
                            Total amount of points awarded but never redeemed.
                            They cannot be used anymore.
                          example: 286
                        negativePoints:
                          type: number
                          title: Current negative balance
                          description: >-
                            Total amount of negative points. This implies that
                            `activePoints` is `0`.
                          example: 286
                    - type: object
                      properties:
                        currentTier:
                          description: Customer's current tier.
                          example: bronze
                          type: object
                          required:
                            - id
                            - name
                          properties:
                            id:
                              type: integer
                              description: The internal ID of the tier.
                              example: 11
                            name:
                              type: string
                              description: The name of the tier.
                              example: bronze
                            startDate:
                              type: string
                              format: date-time
                              description: >-
                                Date and time when the customer moved to this
                                tier. This value uses the loyalty program's time
                                zone setting.
                              example: 2021-05-03T12:32:00Z07:00
                            expiryDate:
                              type: string
                              format: date-time
                              description: >-
                                Date when tier level expires in the RFC3339
                                format (in the Loyalty Program's timezone).
                              example: 2022-08-02T15:04:05Z07:00
                            downgradePolicy:
                              type: string
                              enum:
                                - one_down
                                - balance_based
                              description: >
                                The policy that defines how customer tiers are
                                downgraded in the loyalty program after tier
                                reevaluation.
                                 - `one_down`: If the customer doesn't have enough points to stay in the current tier, they are downgraded by one tier.
                                 - `balance_based`: The customer's tier is reevaluated based on the amount of active points they have at the moment.
                        projectedTier:
                          type: object
                          required:
                            - projectedActivePoints
                          properties:
                            projectedActivePoints:
                              type: number
                              description: >-
                                The active points of the customer when their
                                current tier expires.
                              example: 198
                            stayInTierPoints:
                              type: number
                              description: >
                                The number of points the customer needs to stay
                                in the current tier.


                                **Note**: This is included in the response when
                                the customer is projected to be downgraded.
                              example: 2
                            projectedTierName:
                              type: string
                              description: >-
                                The name of the tier the user will enter once
                                their current tier expires.
                              example: Tier 1
                        pointsToNextTier:
                          type: number
                          description: The number of points required to move up a tier.
                          example: 20
                        nextTierName:
                          type: string
                          description: >-
                            The name of the tier consecutive to the current
                            tier.
                          example: silver
                example:
                  mysubledger:
                    activePoints: 286
                    pendingPoints: 50
                    spentPoints: 150
                    expiredPoints: 25
                    negativePoints: 0
    '400':
      description: Bad request
      content:
        application/json:
          schema:
            type: object
            properties:
              message:
                type: string
              errors:
                type: array
                description: >-
                  An array of individual problems encountered during the
                  request.
                items:
                  type: object
                  required:
                    - source
                    - title
                  properties:
                    title:
                      type: string
                      description: Short description of the problem.
                    details:
                      type: string
                      description: >-
                        Longer description of this specific instance of the
                        problem.
                    source:
                      type: object
                      description: >
                        The source of the current error, exactly one of
                        `pointer`, `parameter` or `line` will be defined.
                      properties:
                        pointer:
                          type: string
                          description: >-
                            Pointer to the path in the payload that caused this
                            error.
                        parameter:
                          type: string
                          description: Query parameter that caused this error.
                        line:
                          type: string
                          description: >-
                            Line number in uploaded multipart file that caused
                            this error. 'N/A' if unknown.
                        resource:
                          type: string
                          description: Pointer to the resource that caused this error.
              StatusCode:
                type: integer
                description: The error code
    '401':
      description: Unauthorized
      content:
        application/json:
          schema:
            type: object
            properties:
              message:
                type: string
              errors:
                type: array
                description: >-
                  An array of individual problems encountered during the
                  request.
                items:
                  type: object
                  required:
                    - source
                    - title
                  properties:
                    title:
                      type: string
                      description: Short description of the problem.
                    details:
                      type: string
                      description: >-
                        Longer description of this specific instance of the
                        problem.
                    source:
                      type: object
                      description: >
                        The source of the current error, exactly one of
                        `pointer`, `parameter` or `line` will be defined.
                      properties:
                        pointer:
                          type: string
                          description: >-
                            Pointer to the path in the payload that caused this
                            error.
                        parameter:
                          type: string
                          description: Query parameter that caused this error.
                        line:
                          type: string
                          description: >-
                            Line number in uploaded multipart file that caused
                            this error. 'N/A' if unknown.
                        resource:
                          type: string
                          description: Pointer to the resource that caused this error.
              StatusCode:
                type: integer
                description: The error code
    '404':
      description: Not found
      content:
        application/json:
          schema:
            type: object
            properties:
              message:
                type: string
              errors:
                type: array
                description: >-
                  An array of individual problems encountered during the
                  request.
                items:
                  type: object
                  required:
                    - source
                    - title
                  properties:
                    title:
                      type: string
                      description: Short description of the problem.
                    details:
                      type: string
                      description: >-
                        Longer description of this specific instance of the
                        problem.
                    source:
                      type: object
                      description: >
                        The source of the current error, exactly one of
                        `pointer`, `parameter` or `line` will be defined.
                      properties:
                        pointer:
                          type: string
                          description: >-
                            Pointer to the path in the payload that caused this
                            error.
                        parameter:
                          type: string
                          description: Query parameter that caused this error.
                        line:
                          type: string
                          description: >-
                            Line number in uploaded multipart file that caused
                            this error. 'N/A' if unknown.
                        resource:
                          type: string
                          description: Pointer to the resource that caused this error.
              StatusCode:
                type: integer
                description: The error code
